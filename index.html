<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leasingkalkulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #F8F9FA;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        .form-input-underline {
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #ced4da;
            border-radius: 0;
            padding: 0.5rem 0.2rem;
            color: #212529;
            transition: border-color 0.3s, border-width 0.3s;
            -webkit-appearance: none; appearance: none;
        }
        .form-input-underline:focus {
            border-color: #032659;
            border-width: 0 0 1px 0;
            box-shadow: none; outline: none;
        }
        .result-field {
            background-color: transparent; border: none; padding: 0.5rem 0.2rem;
            color: #212529; font-weight: 600; font-size: 1.1rem;
        }
        .panel {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .timeline-content {
            display: none;
        }
        #toggle-icon { transition: transform 0.3s ease; }
        
        .toggle-switch {
            position: relative; display: inline-block;
            width: 51px; height: 31px;
        }
        .toggle-switch input {
            opacity: 0; width: 0; height: 0;
        }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 27px; width: 27px;
            left: 2px; bottom: 2px;
            background-color: white;
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #032659; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body class="text-slate-800 min-h-screen p-4 py-8">
    
    <div class="w-full max-w-5xl mx-auto">
        <header class="text-left mb-6">
            <h1 class="text-4xl sm:text-5xl font-bold uppercase" style="color: #032659; letter-spacing: 0.06em;">LEASINGKALKULATOR</h1>
            <p class="mt-4 text-slate-500 text-lg" style="letter-spacing: 0.072em;">Geben Sie die Parameter ein, um Ihre Finanzierung zu kalkulieren.</p>
            <!-- Info-Button mit Tooltip -->
            <div class="flex items-center mt-4">
                <div class="relative inline-block">
                    <span id="info-button" class="text-slate-600 bg-gray-200 hover:bg-gray-300 rounded-full px-2 py-0.5 text-sm font-semibold cursor-help">
                        i
                    </span>
                    <div id="info-tooltip" class="absolute left-1/2 -translate-x-1/2 top-full mt-1 w-64 bg-white border border-gray-300 rounded p-2 text-xs text-slate-700 shadow-md z-20 hidden">
                        Dieser Leasingkalkulator hilft Ihnen, die monatliche Leasingrate, die Gesamtkosten und den indikativen Zinssatz auf Basis Ihrer Eingaben zu berechnen.
                    </div>
                </div>
            </div>
        </header>

        <main class="w-full">
            <div class="panel rounded-2xl shadow-lg relative">
                <div class="grid grid-cols-1 lg:grid-cols-2">
                    <!-- Left Side: Calculator -->
                    <div class="p-6 sm:p-10 flex flex-col h-full">
                        <div class="space-y-8">
                            <!-- Anschaffungswert und Laufzeit -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
                                <div>
                                    <label for="anschaffungswert" class="block text-sm font-medium text-slate-600 mb-1">Anschaffungswert (€)</label>
                                    <input type="text" id="anschaffungswert" value="0" class="w-full form-input-underline text-lg">
                                </div>
                                <div>
                                    <label for="laufzeit" class="block text-sm font-medium text-slate-600 mb-1">Laufzeit (Monate)</label>
                                    <input type="number" id="laufzeit" value="0" class="w-full form-input-underline text-lg">
                                </div>
                            </div>
                            <!-- Anzahlung und Restwert -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
                                <div class="flex items-end">
                                    <div class="w-full">
                                        <label for="anzahlung" class="block text-sm font-medium text-slate-600 mb-1">Anzahlung <span id="anzahlung-unit">(€)</span></label>
                                        <input type="text" id="anzahlung" value="0" class="w-full form-input-underline text-lg">
                                    </div>
                                    <label class="toggle-switch ml-4 flex-shrink-0">
                                        <input type="checkbox" id="anzahlung-toggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-end">
                                    <div class="w-full">
                                        <label for="restwert" class="block text-sm font-medium text-slate-600 mb-1">Restwert <span id="restwert-unit">(€)</span></label>
                                        <input type="text" id="restwert" value="0" class="w-full form-input-underline text-lg">
                                    </div>
                                     <label class="toggle-switch ml-4 flex-shrink-0">
                                        <input type="checkbox" id="restwert-toggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <!-- Basiszins und Marge Gesamt -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
                                <!-- Basiszins -->
                                <div class="flex items-end">
                                    <div class="w-full">
                                        <label for="basiszins" class="block text-sm font-medium text-slate-600 mb-1">Basiszins (% p.a.)</label>
                                        <input type="text" id="basiszins" value="0" class="w-full form-input-underline text-lg">
                                    </div>
                                </div>
                                <!-- Marge Gesamt mit Toggle -->
                                <div class="flex items-end">
                                    <div class="w-full">
                                        <label for="margegesamt" class="flex items-baseline text-sm font-medium text-slate-600 mb-1">
                                            <span>Marge&nbsp;Gesamt</span>
                                            <span id="marge-unit" class="ml-1">(€)</span>
                                        </label>
                                        <input type="text" id="margegesamt" value="0" class="w-full form-input-underline text-lg">
                                    </div>
                                    <label class="toggle-switch ml-4 flex-shrink-0">
                                        <input type="checkbox" id="marge-toggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-auto">
                            <div class="mt-16">
                                <button id="calculate-btn" class="w-full bg-[#032659] text-white font-bold py-4 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-4 focus:ring-[#032659]/50 transition-all duration-300 ease-in-out">Berechnen</button>
                            </div>
                            <div class="mt-12 pt-8 border-t border-[#ced4da]">
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6">
                                    <div>
                                        <label for="indikativer-zins" class="block text-sm font-medium text-slate-600">Indikativer Zins (% p.a.)</label>
                                        <input type="text" id="indikativer-zins" class="w-full result-field" readonly>
                                    </div>
                                    <div>
                                        <label for="leasingfaktor" class="block text-sm font-medium text-slate-600">Leasingfaktor (%)</label>
                                        <input type="text" id="leasingfaktor" class="w-full result-field" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side: Chart -->
                     <div class="p-6 sm:p-10 flex flex-col border-t lg:border-t-0 border-gray-200/50">
                        <div class="h-[7.5rem] flex items-start justify-center pt-1 text-center">
                           <div>
                             <label class="block text-sm font-medium text-slate-600">Monatliche Leasingrate</label>
                              <p id="result-text" class="text-4xl font-bold text-slate-900 mt-2 h-12"></p>
                           </div>
                        </div>
                        <div id="result-container" class="w-full hidden flex-grow flex flex-col justify-center items-center text-center -mt-16">
                            <div id="error-text" class="text-red-500 mt-2 font-medium h-6"></div>
                            <div class="w-full max-w-sm mx-auto"><canvas id="cost-chart"></canvas></div>
                             <div class="mt-12 pt-8 border-t border-[#ced4da] w-full max-w-xs">
                                <div class="text-center">
                                    <label for="gesamtkosten" class="block text-sm font-medium text-slate-600">Gesamtkosten (€)</label>
                                    <input type="text" id="gesamtkosten" class="w-full result-field text-center" readonly>
                                </div>
                            </div>
                        </div>
                        <div id="placeholder-container" class="w-full flex-grow flex flex-col justify-center items-center text-center text-slate-500 -mt-16"><p>Ihre Ergebnisse werden hier angezeigt.</p></div>
                    </div>
                </div>
            </div>
        </main>
        
        <section class="w-full mt-8">
            <div class="panel rounded-2xl shadow-lg p-6">
                <button id="timeline-toggle" class="w-full flex justify-between items-center text-left">
                    <h2 class="text-xl font-bold text-slate-800">Finanzierungsverlauf anzeigen</h2>
                    <!-- Plus-Zeichen statt Pfeil -->
                    <span id="toggle-icon" class="text-3xl font-bold text-slate-800 transition-transform duration-300">+</span>
                </button>
                <div id="timeline-container" class="timeline-content mt-4"><canvas id="timeline-chart"></canvas></div>
            </div>
        </section>
    </div>

    <script>
        // DOM Elements
        const anzahlungToggle = document.getElementById('anzahlung-toggle');
        const restwertToggle = document.getElementById('restwert-toggle');
        const margeToggle = document.getElementById('marge-toggle');
        const anzahlungUnit = document.getElementById('anzahlung-unit');
        const restwertUnit = document.getElementById('restwert-unit');
        const margeUnit = document.getElementById('marge-unit');
        const calculateBtn = document.getElementById('calculate-btn');
        const resultContainer = document.getElementById('result-container');
        const placeholderContainer = document.getElementById('placeholder-container');
        const resultText = document.getElementById('result-text');
        const errorText = document.getElementById('error-text');
        const costChartCanvas = document.getElementById('cost-chart');
        const timelineChartCanvas = document.getElementById('timeline-chart');
        const indikativerZinsEl = document.getElementById('indikativer-zins');
        const leasingfaktorEl = document.getElementById('leasingfaktor');
        const gesamtkostenEl = document.getElementById('gesamtkosten');
        const timelineToggle = document.getElementById('timeline-toggle');
        const timelineContainer = document.getElementById('timeline-container');
        const toggleIcon = document.getElementById('toggle-icon');
        const infoButton = document.getElementById('info-button');
        const infoTooltip = document.getElementById('info-tooltip');

        let costChart = null;
        let timelineChart = null;
        
        // Tooltip hover
        infoButton.addEventListener('mouseenter', () => {
            infoTooltip.classList.remove('hidden');
        });
        infoButton.addEventListener('mouseleave', () => {
            infoTooltip.classList.add('hidden');
        });
        
        // Utility & Formatting
        function unformat(str) {
            if (typeof str !== 'string' || !str) return 0;
            return parseFloat(str.replace(/\./g, '').replace(',', '.'));
        }

        function formatLocale(num, options = {}) {
            if (isNaN(num)) return '';
            return num.toLocaleString('de-DE', options);
        }
        
        function formatInput(e) {
            const input = e.target;
            let value = input.value;
            let cursorPosition = input.selectionStart;
            const originalValue = value;
            
            let cleanValue = value.replace(/[^\d,]/g, '');
            const parts = cleanValue.split(',');
            if (parts.length > 2) cleanValue = parts[0] + ',' + parts.slice(1).join('');
            if (parts[1] && parts[1].length > 2) cleanValue = parts[0] + ',' + parts[1].substring(0, 2);
            
            let [integer, fraction] = cleanValue.split(',');
            const originalIntegerLength = integer.length;
            const formattedInteger = integer.replace(/\./g, '').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            const finalValue = fraction !== undefined ? `${formattedInteger},${fraction}` : formattedInteger;

            if (input.value !== finalValue) {
                const diff = formattedInteger.length - originalIntegerLength;
                cursorPosition += diff;
                input.value = finalValue;
                input.setSelectionRange(cursorPosition, cursorPosition);
            }
            
            if (unformat(originalValue) !== unformat(input.value)) {
                 performCalculation();
            }
        }

        // Financial functions
        function PMT(rate, nper, pv, fv = 0) {
            if (rate === 0) return -(pv + fv) / nper;
            const pvif = Math.pow(1 + rate, nper);
            let pmt = rate * (fv + pv * pvif) / (pvif - 1);
            return -pmt;
        }

        function RATE(nper, pmt, pv, fv) {
            const financialPrecision = 1e-7;
            const maxIterations = 100;
            let rateLow = -0.99, rateHigh = 5;

            const f = (rate) => {
                if (rate === 0) return pv + pmt * nper + fv;
                return pv * Math.pow(1 + rate, nper) + pmt * (Math.pow(1 + rate, nper) - 1) / rate + fv;
            };

            for (let i = 0; i < maxIterations; i++) {
                if (rateLow >= rateHigh) break;
                let rateMid = (rateLow + rateHigh) / 2;
                let fMid = f(rateMid);
                if (Math.abs(fMid) < financialPrecision) return rateMid * 12;
                if (f(rateLow) * fMid < 0) rateHigh = rateMid; else rateLow = rateMid;
            }
            return ((rateLow + rateHigh) / 2) * 12; 
        }

        // Core calculation
        function performCalculation() {
            const getEl = (id) => document.getElementById(id);
            const av = unformat(getEl('anschaffungswert').value);
            const lz = parseInt(getEl('laufzeit').value) || 0;
            const bz = unformat(getEl('basiszins').value);
            
            const azInput = unformat(getEl('anzahlung').value);
            const rwInput = unformat(getEl('restwert').value);
            const margeInput = unformat(getEl('margegesamt').value);
            
            const az = getEl('anzahlung-toggle').checked ? (azInput / 100) * av : azInput;
            const rw = getEl('restwert-toggle').checked ? (rwInput / 100) * av : rwInput;
            const marge = getEl('marge-toggle').checked ? (margeInput / 100) * av : margeInput;

            if (av <= 0 || lz <= 0) {
                showError("Anschaffungswert und Laufzeit müssen größer als 0 sein.");
                return;
            }
            hideError();
            
            const principal = av - az + marge;
            const monatszins_basis = bz / 100 / 12;

            const leasingrateInternal = PMT(monatszins_basis, lz, principal, -rw);
            const leasingrate = -leasingrateInternal;
            
            const finanzierungsbetrag = av - az;
            displayResult(leasingrate, az, rw, av, lz);
            
            const indikativerZins = RATE(lz, leasingrateInternal, finanzierungsbetrag, -rw);
            indikativerZinsEl.value = formatLocale(indikativerZins * 100, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' %';
            
            if (timelineContainer.style.display === "block") {
                generateTimelineChart(finanzierungsbetrag, leasingrate, lz, indikativerZins);
            }
        }

        // UI updates
        function displayResult(rate, anzahlung, restwert, av, monate) {
            resultContainer.classList.remove('hidden');
            resultContainer.classList.add('fade-in');
            placeholderContainer.classList.add('hidden');
            resultText.textContent = formatLocale(rate, { style: 'currency', currency: 'EUR' });
            
            // Gesamtkosten: Anzahlung + Summe der Raten + Restwert
            const gesamtkosten = anzahlung + (rate * (monate || 0)) + restwert;
            gesamtkostenEl.value = formatLocale(gesamtkosten, { style: 'currency', currency: 'EUR' });
            
            const leasingfaktor = av > 0 ? (rate / av) * 100 : 0;
            leasingfaktorEl.value = formatLocale(leasingfaktor, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' %';

            updateCostChart(anzahlung, rate * (monate || 0), restwert);
        }
        
        function updateCostChart(anzahlung, summeRaten, restwert) {
            if (costChart) costChart.destroy();
            const ctx = costChartCanvas.getContext('2d');
            const datasetValues = [anzahlung, summeRaten, restwert];
            const fullTotal = datasetValues.reduce((a, b) => a + b, 0);
            costChart = new Chart(ctx, {
                type: 'doughnut', 
                data: {
                    labels: ['Anzahlung', 'Summe der Raten', 'Restwert'],
                    datasets: [{
                        data: datasetValues,
                       backgroundColor: ['#4169E1', '#004225', '#B0C4DE'],
                        borderColor: '#F8F9FA', borderWidth: 5, hoverOffset: 10
                    }]
                },
                options: { 
                    responsive: true, 
                    cutout: '75%',
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            align: 'start',
                            labels: { 
                                color: '#6C757D', 
                                padding: 20, 
                                boxWidth: 12, 
                                font: { size: 14, family: "'Montserrat', sans-serif" } 
                            },
                            // Beim Klick Legende und Gesamtkosten aktualisieren
                            onClick: function (e, legendItem, legend) {
                                const index = legendItem.index;
                                const ci = legend.chart;
                                // Standard-Toggle
                                ci.toggleDataVisibility(index);
                                ci.update();
                                // Neu berechnen: nur sichtbare Segmente
                                let sumVisible = 0;
                                ci.getDatasetMeta(0).data.forEach((arc, i) => {
                                    if (ci.getDataVisibility(i)) {
                                        sumVisible += ci.data.datasets[0].data[i];
                                    }
                                });
                                gesamtkostenEl.value = formatLocale(sumVisible, { style: 'currency', currency: 'EUR' });
                            }
                        },
                        tooltip: { 
                            callbacks: { 
                                label: (c) => `${c.label}: ${formatLocale(c.parsed, { style: 'currency', currency: 'EUR' })}`
                            }
                        } 
                    }
                }
            });
            // Sicherstellen, dass Gesamtkosten dem vollen Wert entsprechen
            gesamtkostenEl.value = formatLocale(fullTotal, { style: 'currency', currency: 'EUR' });
        }

        function generateTimelineChart(startkapital, rate, monate, jahreszins) {
            if (timelineChart) timelineChart.destroy();
            let restschuld = startkapital;
            const monatszins = jahreszins / 12;
            const labels = [], zinsanteile = [], tilgungsanteile = [], restschulden = [];
            for (let i = 1; i <= monate; i++) {
                labels.push(`M ${i}`);
                const zinsanteil = restschuld * monatszins;
                const tilgungsanteil = rate - zinsanteil;
                restschuld -= tilgungsanteil;
                zinsanteile.push(zinsanteil);
                tilgungsanteile.push(tilgungsanteil);
                restschulden.push(restschuld > 0 ? restschuld : 0);
            }
            const ctx = timelineChartCanvas.getContext('2d');
            timelineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        type: 'line', label: 'Restschuld', data: restschulden,
                        borderColor: '#032659', yAxisID: 'y1', tension: 0.1
                    },{
                        label: 'Zinsanteil', data: zinsanteile, backgroundColor: '#B0C4DE', yAxisID: 'y'
                    }, {
                        label: 'Tilgungsanteil', data: tilgungsanteile, backgroundColor: '#4169E1', yAxisID: 'y'
                    }]
                },
                options: { 
                    plugins: { legend: { position: 'top' } }, 
                    responsive: true, 
                    scales: { 
                        x: { stacked: true }, 
                        y: { 
                            position: 'left', stacked: true, beginAtZero: true, 
                            title: { display: true, text: 'Ratenzusammensetzung (€)' } 
                        }, 
                        y1: { 
                            type: 'linear', 
                            display: true, 
                            position: 'right', 
                            beginAtZero: true, 
                            title: { display: true, text: 'Restschuld (€)' }, 
                            grid: { drawOnChartArea: false } 
                        } 
                    } 
                }
            });
        }

        function showError(message) {
            resultText.textContent = '';
            errorText.textContent = message;
            indikativerZinsEl.value = '';
            leasingfaktorEl.value = '';
            gesamtkostenEl.value = '';
            resultContainer.classList.add('hidden');
            if (costChart) costChart.destroy();
            if (timelineChart) timelineChart.destroy();
        }
        function hideError() { errorText.textContent = ''; }

        // Toggle helper
        function setupToggle(toggleEl, inputEl, unitEl) {
             toggleEl.addEventListener('change', () => {
                const av = unformat(document.getElementById('anschaffungswert').value);
                const currentValue = unformat(inputEl.value);
                
                if (toggleEl.checked) {
                    unitEl.textContent = '(%)';
                    if (av > 0) {
                        inputEl.value = formatLocale((currentValue / av) * 100, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                } else {
                    unitEl.textContent = '(€)';
                    if (av > 0) {
                        inputEl.value = formatLocale((currentValue / 100) * av, { maximumFractionDigits: 0 });
                    }
                }
                performCalculation();
            });
        }
        setupToggle(anzahlungToggle, document.getElementById('anzahlung'), anzahlungUnit);
        setupToggle(restwertToggle, document.getElementById('restwert'), restwertUnit);
        setupToggle(margeToggle, document.getElementById('margegesamt'), margeUnit);
        
        // Event listeners
        document.querySelectorAll('input[type="text"]').forEach(input => input.addEventListener('input', formatInput));
        document.getElementById('laufzeit').addEventListener('input', performCalculation);
        
        calculateBtn.addEventListener('click', performCalculation);
        timelineToggle.addEventListener('click', () => {
            const container = timelineContainer;
            const icon = toggleIcon;
            if (container.style.display === "block") {
                container.style.display = "none";
                icon.style.transform = 'rotate(0deg)';
            } else {
                container.style.display = "block";
                icon.style.transform = 'rotate(45deg)';
                performCalculation(); 
            }
        });

        window.addEventListener('load', performCalculation);
    </script>
</body>
</html>
