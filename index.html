<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finanzierungskalkulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #F8F9FA;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }
    .form-input-underline {
      background-color: transparent;
      border: none;
      border-bottom: 1px solid #ced4da;
      border-radius: 0;
      padding: 0.5rem 0.2rem;
      color: #212529;
      transition: border-color 0.3s, border-width 0.3s;
      -webkit-appearance: none;
          appearance: none;
    }
    .form-input-underline:focus {
      border-color: #032659;
      border-width: 0 0 1px 0;
      box-shadow: none;
      outline: none;
    }
    .form-input-underline.has-error {
        border-color: #ef4444; /* red-500 */
    }
    .error-icon {
        position: absolute;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        color: #ef4444;
        width: 1.25rem; /* w-5 */
        height: 1.25rem; /* h-5 */
    }

    .result-field {
      background-color: transparent;
      border: none;
      padding: 0.5rem 0.2rem;
      color: #212529;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .panel {
      background-color: #ffffff;
      border: 1px solid #f0f0f0;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      border-radius: 0.75rem;
    }
    .toggle-section {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.45s ease, margin-top 0.45s ease;
    }
    .toggle-section.open-offer { margin-top: 2rem; }
    #offer-icon {
      font-weight: 500;
      transition: transform 0.5s ease-in-out;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 51px;
      height: 31px;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 27px;
      width: 27px;
      left: 2px;
      bottom: 2px;
      background-color: #ffffff;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #032659; }
    input:checked + .slider:before { transform: translateX(20px); }

    select.is-placeholder {
        color: #9ca3af; /* text-gray-400 */
        font-size: 0.95rem;
    }

    /* History Modal */
    #history-modal {
        transition: opacity 0.3s ease-in-out;
    }
    #history-panel {
        transition: transform 0.3s ease-in-out;
    }
     /* Style Search Input */
    #history-search {
        border: 1px solid #d1d5db; /* gray-300 */
        border-radius: 0.375rem; /* rounded-md */
        padding: 0.5rem 0.75rem;
        width: 100%;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.875rem; /* text-sm */
    }
     #history-search:focus {
        outline: 2px solid transparent;
        outline-offset: 2px;
        border-color: #032659;
        box-shadow: 0 0 0 2px rgba(3, 38, 89, 0.3);
     }
    /* Style for the info and reset buttons */
    .header-button-wrapper {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        background-color: #e2e8f0; /* bg-gray-200 */
        border-radius: 9999px; /* rounded-full */
        font-size: 0.875rem; /* text-sm */
        font-weight: 700; /* font-bold */
        cursor: pointer;
        user-select: none;
        transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
        transition-duration: 150ms;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        padding: 0.25rem 0.625rem; /* px-2.5 py-0.5 */
        height: 28px;
        min-width: 28px;
    }
    .header-button-wrapper:hover {
        background-color: #cbd5e1; /* hover:bg-gray-300 */
    }
  </style>
</head>
<body class="text-slate-800 min-h-screen p-4 py-16">
<div class="w-full max-w-5xl mx-auto">
  <!-- Header -->
  <header class="text-left mt-6 mb-6 flex justify-between items-start">
    <div>
      <h1 class="text-4xl sm:text-5xl font-bold uppercase" style="color: #032659; letter-spacing: 0.06em;">
        FINANZIERUNGSKALKULATOR
      </h1>
      <p class="mt-4 text-slate-500 text-lg" style="letter-spacing: 0.072em;">
        Gib deine Werte ein und erhalte die Rate, Kosten und den Zins.
      </p>
      <!-- Info-Button & Reset-Button -->
      <div class="flex items-center mt-4">
        <!-- Info Button -->
        <div class="relative inline-block">
          <span id="info-button" class="text-slate-600 header-button-wrapper">i</span>
          <div id="info-tooltip" class="absolute left-1/2 -translate-x-1/2 top-full mt-2 w-72 bg-white border border-gray-300 rounded-lg p-3 text-xs text-slate-700 shadow-xl z-20 hidden">
            <b>1) Werte eingeben:</b> Anschaffungswert, Laufzeit sowie Anzahlung, Restwert und Marge (in € oder % über den Schalter).<br><br>
            <b>2) „Berechnen“ klicken:</b> Rate, Gesamtkosten und Zins erscheinen; der Ring zeigt die Kostenanteile.<br><br>
            <b>3) Angebot erstellen:</b> Kontaktdaten ausfüllen (Leasing/Mietkauf) und PDF herunterladen.
          </div>
        </div>
        <!-- Reset Button -->
        <button id="reset-button" title="Eingaben zurücksetzen" class="ml-2 text-[#032659] header-button-wrapper">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
          </svg>
        </button>
      </div>
    </div>
    <!-- History Button: nach unten gesetzt (gleiche Zeile wie Info/Reset) -->
    <div class="mt-4">
      <button id="history-button" title="Berechnungsverlauf anzeigen" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </button>
    </div>
  </header>

  <!-- Kalkulator-Panel -->
  <main class="w-full">
    <div class="panel rounded-2xl relative">
      <div class="grid grid-cols-1 lg:grid-cols-2">
        <!-- Eingabe-Spalte -->
        <div class="p-6 sm:p-10 flex flex-col h-full">
          <div class="space-y-8">
            <!-- Anschaffungswert & Laufzeit -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
              <div>
                <label for="anschaffungswert" class="block text-sm font-medium text-slate-600 mb-1">
                  Anschaffungswert (€)
                </label>
                <input type="text" id="anschaffungswert" value="0" class="numeric-input w-full form-input-underline text-lg" />
              </div>
              <div>
                <label for="laufzeit" class="block text-sm font-medium text-slate-600 mb-1">
                  Laufzeit (Monate)
                </label>
                <input type="number" id="laufzeit" value="0" class="w-full form-input-underline text-lg" />
              </div>
            </div>

            <!-- Anzahlung & Restwert -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
              <div class="flex items-end">
                <div class="w-full">
                  <label for="anzahlung" class="block text-sm font-medium text-slate-600 mb-1">
                    Anzahlung <span id="anzahlung-unit">(€)</span>
                  </label>
                  <input type="text" id="anzahlung" value="0" class="numeric-input w-full form-input-underline text-lg" />
                </div>
                <label class="toggle-switch ml-4 flex-shrink-0">
                  <input type="checkbox" id="anzahlung-toggle" />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="flex items-end">
                <div class="w-full">
                  <label for="restwert" class="block text-sm font-medium text-slate-600 mb-1">
                    Restwert <span id="restwert-unit">(€)</span>
                  </label>
                  <input type="text" id="restwert" value="0" class="numeric-input w-full form-input-underline text-lg" />
                </div>
                <label class="toggle-switch ml-4 flex-shrink-0">
                  <input type="checkbox" id="restwert-toggle" />
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <!-- Basiszins & Marge -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
              <div class="flex items-end">
                <div class="w-full">
                  <label for="basiszins" class="block text-sm font-medium text-slate-600 mb-1">
                    Basiszins (% p.a.)
                  </label>
                  <input type="text" id="basiszins" value="0" class="numeric-input w-full form-input-underline text-lg" />
                </div>
              </div>
              <div class="flex items-end">
                <div class="w-full">
                  <!-- FIX: nicht umbrechen -->
                  <label for="margegesamt" class="block text-sm font-medium text-slate-600 mb-1">
                    <span class="flex items-center gap-1 whitespace-nowrap">
                      Marge Gesamt <span id="marge-unit">(€)</span>
                    </span>
                  </label>
                  <input type="text" id="margegesamt" value="0" class="numeric-input w-full form-input-underline text-lg" />
                </div>
                <label class="toggle-switch ml-4 flex-shrink-0">
                  <input type="checkbox" id="marge-toggle" />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>

          <div class="mt-16">
            <button id="calculate-btn" class="w-full bg-[#032659] text-white font-bold py-4 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-4 focus:ring-[#032659]/50 transition-all duration-300 ease-in-out">
              Berechnen
            </button>
          </div>

          <!-- ZINS / FAKTOR / GESAMTKOSTEN: jetzt eine gemeinsame Reihe -->
          <div class="mt-12 pt-8 border-t border-[#ced4da]">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-10 gap-y-6">
              <div>
                <label for="indikativer-zins" class="block text-sm font-medium text-slate-600">
                  Indikativer Zins (% p.a.)
                </label>
                <input type="text" id="indikativer-zins" class="w-full result-field" readonly />
              </div>
              <div>
                <label for="leasingfaktor" class="block text-sm font-medium text-slate-600">
                  Leasingfaktor (%)
                </label>
                <input type="text" id="leasingfaktor" class="w-full result-field" readonly />
              </div>
              <div>
                <label for="gesamtkosten" class="block text-sm font-medium text-slate-600">
                  Gesamtkosten (€)
                </label>
                <input type="text" id="gesamtkosten" class="w-full result-field" readonly />
              </div>
            </div>
          </div>

          <div class="mt-auto"></div>
        </div>

        <!-- Ergebnis-Spalte (Chart & Werte) -->
        <div class="p-6 sm:p-10 flex flex-col border-t lg:border-t-0 border-gray-200/50">
          <div class="h-[7.5rem] flex items-start justify-center pt-1 text-center">
            <div>
              <label class="block text-sm font-medium text-slate-600">Monatliche Leasingrate</label>
              <p id="result-text" class="text-4xl font-bold text-slate-900 mt-2 h-12"></p>
            </div>
          </div>

          <div id="result-container" class="w-full hidden flex-grow flex flex-col justify-center items-center text-center -mt-16">
            <div id="error-text" class="text-red-500 mt-2 font-medium h-6"></div>
            <div class="w-full max-w-sm mx-auto">
              <canvas id="cost-chart"></canvas>
            </div>
            <!-- HINWEIS: „Gesamtkosten“ Block wurde in die linke Spalte (Dreier-Grid) verlegt -->
          </div>

          <div id="placeholder-container" class="w-full flex-grow flex flex-col justify-center items-center text-center text-slate-500 -mt-16">
            <p>Ihre Ergebnisse werden hier angezeigt.</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Angebot erstellen -->
  <section class="w-full mt-8">
    <div class="panel rounded-2xl p-6 sm:p-10">
      <button id="offer-toggle" class="w-full flex justify-between items-center text-left">
        <h2 class="text-xl font-bold text-slate-800">Angebot erstellen</h2>
        <span id="offer-icon" class="text-3xl text-slate-800">+</span>
      </button>
      <div id="offer-container" class="toggle-section">
        <form class="space-y-8" novalidate>
          <!-- Finanzierungsart & Anrede -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
            <div>
              <label for="finanzierungsart" class="block text-sm font-medium text-slate-600 mb-1">Finanzierungsart</label>
              <div class="relative">
                <select id="finanzierungsart" class="w-full form-input-underline text-lg is-placeholder" required>
                  <option value="">Bitte wählen</option>
                  <option>Leasing</option>
                  <option>Mietkauf</option>
                </select>
                <svg class="error-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
              </div>
            </div>
            <div>
              <label for="anrede" class="block text-sm font-medium text-slate-600 mb-1">Anrede</label>
              <div class="relative">
                <select id="anrede" class="w-full form-input-underline text-lg is-placeholder" required>
                  <option value="">Bitte wählen</option>
                  <option>Herr</option>
                  <option>Frau</option>
                </select>
                <svg class="error-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
              </div>
            </div>
          </div>

          <!-- Vorname & Nachname -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
            <div>
              <label for="vorname" class="block text-sm font-medium text-slate-600 mb-1">Vorname</label>
              <div class="relative">
                <input type="text" id="vorname" class="w-full form-input-underline text-lg" required />
                <svg class="error-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
              </div>
            </div>
            <div>
              <label for="nachname" class="block text-sm font-medium text-slate-600 mb-1">Nachname</label>
              <div class="relative">
                <input type="text" id="nachname" class="w-full form-input-underline text-lg" required />
                <svg class="error-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
              </div>
            </div>
          </div>

          <!-- Firma -->
          <div>
            <label for="firma" class="block text-sm font-medium text-slate-600 mb-1">Firma</label>
            <div class="relative">
              <input type="text" id="firma" class="w-full form-input-underline text-lg" required />
              <svg class="error-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
            </div>
          </div>

          <!-- Adresse, PLZ, Ort -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-x-10 gap-y-8">
            <div>
              <label for="adresse" class="block text-sm font-medium text-slate-600 mb-1">Adresse &amp; Hausnummer</label>
              <div class="relative">
                <input type="text" id="adresse" class="w-full form-input-underline text-lg" required />
                <svg class="error-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
              </div>
            </div>
            <div>
              <label for="plz" class="block text-sm font-medium text-slate-600 mb-1">Postleitzahl</label>
              <div class="relative">
                <input type="text" id="plz" class="w-full form-input-underline text-lg" required />
                <svg class="error-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
              </div>
            </div>
            <div>
              <label for="ort" class="block text-sm font-medium text-slate-600 mb-1">Ort</label>
              <div class="relative">
                <input type="text" id="ort" class="w-full form-input-underline text-lg" required />
                <svg class="error-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
              </div>
            </div>
          </div>

          <!-- Objekt & Hersteller -->
          <div>
            <label for="objekt" class="block text-sm font-medium text-slate-600 mb-1">Objekt</label>
            <div class="relative">
              <input type="text" id="objekt" class="w-full form-input-underline text-lg" required />
              <svg class="error-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
            </div>
          </div>
          <div>
            <label for="hersteller" class="block text-sm font-medium text-slate-600 mb-1">Hersteller</label>
            <div class="relative">
              <input type="text" id="hersteller" class="w-full form-input-underline text-lg" required />
              <svg class="error-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
            </div>
          </div>

          <!-- Fehler + Download -->
          <div class="mt-8 text-center min-h-[7rem] flex flex-col justify-end pb-2">
            <p id="offer-error-message" class="text-red-600 text-sm mb-4 hidden"></p>
            <button type="button" id="download-pdf-btn" class="w-full md:w-1/2 mx-auto bg-[#032659] text-white font-bold py-4 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-4 focus:ring-[#032659]/50 transition-all duration-300 ease-in-out">
              Angebot herunterladen
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- (Finanzierungsverlauf wurde vollständig entfernt) -->
</div>

<!-- History Modal -->
<div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
  <div id="history-panel" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col transform -translate-y-10">
    <div class="flex justify-between items-center p-4 border-b">
      <h2 class="text-xl font-bold text-slate-800">Verlauf der Berechnungen</h2>
      <button id="close-history-button" class="p-2 rounded-full hover:bg-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <!-- Search Input -->
    <div class="p-4 border-b">
      <input type="search" id="history-search" placeholder="Suche nach Name, Firma, Objekt, Wert..." class="form-input-underline w-full !border !border-gray-300 rounded-md text-sm" />
    </div>
    <div id="history-list" class="overflow-y-auto p-4 space-y-3 flex-grow"></div>
  </div>
</div>

<script>
  // Hilfsfunktionen
  const unformat = (str) => {
    if (typeof str !== 'string' || !str) return 0;
    return parseFloat(str.replace(/\./g, '').replace(',', '.').replace(/\s/g, '')) || 0;
  };
  function formatLocale(value, options = {}) {
    if (value === null || value === undefined || value === '') return '';
    const numValue = Number(value);
    if (isNaN(numValue)) return '';
    const defaultOptions = { style: 'currency', currency: 'EUR', ...options };
    return numValue.toLocaleString('de-DE', defaultOptions);
  }
  function formatInput(event) {
    const el = event.target;
    if (!el.value || el.value === ',' || el.value === '.') return;
    if (el.classList.contains('numeric-input') || el.id === 'basiszins') {
      const numericValue = unformat(el.value);
      if (!isNaN(numericValue)) {
        el.value = formatLocale(numericValue, { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 });
      } else {
        el.value = '';
      }
    } else if (el.id === 'laufzeit') {
      const intValue = parseInt(el.value.replace(/\D/g, ''));
      el.value = isNaN(intValue) ? '' : intValue.toString();
    }
  }

  // Finanzierungsformeln
  function PMT(rate, nper, pv, fv = 0) {
    if (rate === 0) return -(pv + fv) / nper;
    const pvFactor = Math.pow(1 + rate, nper);
    return -(rate * (fv + pv * pvFactor)) / (pvFactor - 1);
  }
  function RATE(nper, pmt, pv, fv = 0) {
    const precision = 1e-7;
    const maxIter = 100;
    let low = -0.99, high = 5;
    nper = Number(nper); pmt = Number(pmt); pv = Number(pv); fv = Number(fv);
    if (isNaN(nper) || isNaN(pmt) || isNaN(pv) || isNaN(fv) || nper <= 0) { return NaN; }
    if (Math.abs(pv + pmt * nper + fv) < precision) { return 0; }
    const f = (rate) => {
      if (rate === 0) return pv + pmt * nper + fv;
      if (rate <= -1) return Infinity;
      try {
        const factor = Math.pow(1 + rate, nper);
        return pv * factor + pmt * ((factor - 1) / rate) + fv;
      } catch { return Infinity; }
    };
    let fLow = f(low), fHigh = f(high);
    if (isNaN(fLow) || isNaN(fHigh)) return NaN;
    if (fLow * fHigh >= 0) {
      if (fLow > 0 && fHigh > 0) { low = -0.9999; fLow = f(low); }
      else if (fLow < 0 && fHigh < 0) { high = 10; fHigh = f(high); }
      if (isNaN(fLow) || isNaN(fHigh) || fLow * fHigh >= 0) return NaN;
    }
    for (let i = 0; i < maxIter; i++) {
      if (isNaN(low) || isNaN(high) || low >= high) return NaN;
      const mid = (low + high) / 2;
      if (mid === low || mid === high) break;
      const fMid = f(mid);
      if (isNaN(fMid)) { if (fLow < 0) high = mid; else low = mid; continue; }
      if (Math.abs(fMid) < precision) return mid * 12;
      fLow = f(low);
      if (isNaN(fLow)) { low = mid; continue; }
      if (fLow * fMid < 0) { high = mid; } else { low = mid; }
    }
    return ((low + high) / 2) * 12;
  }

  // DOM-Elemente
  let costChart = null;
  const anzahlungToggle = document.getElementById('anzahlung-toggle');
  const restwertToggle = document.getElementById('restwert-toggle');
  const margeToggle = document.getElementById('marge-toggle');
  const anzahlungUnit = document.getElementById('anzahlung-unit');
  const restwertUnit = document.getElementById('restwert-unit');
  const margeUnit = document.getElementById('marge-unit');
  const indikativerZinsEl = document.getElementById('indikativer-zins');
  const leasingfaktorEl = document.getElementById('leasingfaktor');
  const gesamtkostenEl = document.getElementById('gesamtkosten');
  const resultContainer = document.getElementById('result-container');
  const placeholderContainer = document.getElementById('placeholder-container');
  const resultText = document.getElementById('result-text');
  const errorText = document.getElementById('error-text');
  const costChartCanvas = document.getElementById('cost-chart');
  const offerToggleBtn = document.getElementById('offer-toggle');
  const offerContainer = document.getElementById('offer-container');
  const offerIcon = document.getElementById('offer-icon');
  const pdfButton = document.getElementById('download-pdf-btn');
  const calculateBtn = document.getElementById('calculate-btn');
  const infoButton = document.getElementById('info-button');
  const infoTooltip = document.getElementById('info-tooltip');
  const resetButton = document.getElementById('reset-button');

  // History
  const historyButton = document.getElementById('history-button');
  const historyModal = document.getElementById('history-modal');
  const historyPanel = document.getElementById('history-panel');
  const closeHistoryButton = document.getElementById('close-history-button');
  const historyList = document.getElementById('history-list');
  const historySearchInput = document.getElementById('history-search');

  // Hauptberechnung
  function performCalculation(isRestoring = false) {
    if (!calculateBtn.dataset.clicked && !isRestoring) {
      showPlaceholder();
      return;
    }

    const av = unformat(document.getElementById('anschaffungswert').value);
    const lz = parseInt(document.getElementById('laufzeit').value) || 0;
    const bz = unformat(document.getElementById('basiszins').value);
    const azInput = unformat(document.getElementById('anzahlung').value);
    const rwInput = unformat(document.getElementById('restwert').value);
    const margeInput = unformat(document.getElementById('margegesamt').value);
    const az = anzahlungToggle.checked ? (azInput / 100) * av : azInput;
    const rw = restwertToggle.checked ? (rwInput / 100) * av : rwInput;
    const marge = margeToggle.checked ? (margeInput / 100) * av : margeInput;

    if (av <= 0 || lz <= 0) {
      showError("Anschaffungswert und Laufzeit müssen größer als 0 sein.");
      clearResultsOnError();
      return;
    }

    hideError();
    const finanzierungsbetrag = av - az;
    const principal = av - az + marge;

    const monRate = bz / 100 / 12;
    if (isNaN(monRate) || isNaN(lz) || isNaN(principal) || isNaN(rw)) {
      showError("Ungültige Eingabe für Zinsberechnung.");
      clearResultsOnError();
      return;
    }

    const leasingInternal = PMT(monRate, lz, principal, -rw);
    if (isNaN(leasingInternal) || !isFinite(leasingInternal)) {
      showError("Berechnung der Rate fehlgeschlagen. Prüfen Sie die Eingaben.");
      clearResultsOnError();
      return;
    }

    const leasingRate = -leasingInternal;

    if (!isRestoring && calculateBtn.dataset.clicked === "true" && av > 0 && lz > 0) {
      const offerData = {
        finanzierungsart: document.getElementById('finanzierungsart').value || '',
        anrede: document.getElementById('anrede').value || '',
        vorname: document.getElementById('vorname').value || '',
        nachname: document.getElementById('nachname').value || '',
        firma: document.getElementById('firma').value || '',
        adresse: document.getElementById('adresse').value || '',
        plz: document.getElementById('plz').value || '',
        ort: document.getElementById('ort').value || '',
        objekt: document.getElementById('objekt').value || '',
        hersteller: document.getElementById('hersteller').value || '',
      };
      saveCalculationToHistory(leasingRate, offerData);
    }

    displayResult(leasingRate, az, rw, av, lz);

    const indZins = RATE(lz, leasingInternal, finanzierungsbetrag, -rw);
    if (!isNaN(indZins)) {
      indikativerZinsEl.value = formatLocale(indZins * 100, { style:'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' %';
    } else {
      indikativerZinsEl.value = 'N/A';
      console.error("RATE calculation failed.");
    }

    calculateBtn.dataset.clicked = "false";
  }

  // Reset
  function resetAllInputs() {
    // 1. Calculator Inputs
    document.getElementById('anschaffungswert').value = '0';
    document.getElementById('laufzeit').value = '0';
    document.getElementById('basiszins').value = '0';
    document.getElementById('anzahlung').value = '0';
    document.getElementById('restwert').value = '0';
    document.getElementById('margegesamt').value = '0';

    // 2. Toggles
    if (anzahlungToggle.checked) anzahlungToggle.checked = false;
    if (restwertToggle.checked) restwertToggle.checked = false;
    if (margeToggle.checked) margeToggle.checked = false;
    anzahlungUnit.textContent = '(€)';
    restwertUnit.textContent = '(€)';
    margeUnit.textContent = '(€)';

    // 3. Format Inputs
    document.querySelectorAll('.numeric-input, #laufzeit').forEach(input => formatInput({ target: input }));

    // 4. Offer Form
    document.getElementById('finanzierungsart').value = '';
    document.getElementById('anrede').value = '';
    document.getElementById('vorname').value = '';
    document.getElementById('nachname').value = '';
    document.getElementById('firma').value = '';
    document.getElementById('adresse').value = '';
    document.getElementById('plz').value = '';
    document.getElementById('ort').value = '';
    document.getElementById('objekt').value = '';
    document.getElementById('hersteller').value = '';

    // 5. Select placeholders
    document.querySelectorAll('select.is-placeholder').forEach(select => {
      select.classList.add('is-placeholder');
      const parent = select.closest('.relative');
      const icon = parent?.querySelector('.error-icon');
      select.classList.remove('has-error');
      if (icon) icon.classList.add('hidden');
    });

    // 6. Offer form errors
    const offerErrorMessage = document.getElementById('offer-error-message');
    offerErrorMessage.classList.add('hidden');
    offerErrorMessage.textContent = '';
    offerContainer.querySelectorAll('input[required]').forEach(field => {
      const parent = field.closest('.relative');
      const icon = parent?.querySelector('.error-icon');
      field.classList.remove('has-error');
      if (icon) icon.classList.add('hidden');
    });

    // 7. Results
    showPlaceholder();

    // 8. Reset clicked flag
    calculateBtn.dataset.clicked = "false";
  }

  function clearResultsOnError() {
    if (costChart) { costChart.destroy(); costChart = null; }
    resultText.textContent = '';
    indikativerZinsEl.value = '';
    leasingfaktorEl.value = '';
    gesamtkostenEl.value = '';
    resultContainer.classList.add('hidden');
    placeholderContainer.classList.remove('hidden');
  }

  function showPlaceholder() {
    if (costChart) { costChart.destroy(); costChart = null; }
    resultText.textContent = '';
    indikativerZinsEl.value = '';
    leasingfaktorEl.value = '';
    gesamtkostenEl.value = '';
    resultContainer.classList.add('hidden');
    placeholderContainer.classList.remove('hidden');
    hideError();
  }

  function displayResult(rate, anzahlung, restwert, av, monate) {
    resultContainer.classList.remove('hidden');
    resultContainer.classList.add('fade-in');
    placeholderContainer.classList.add('hidden');
    resultText.textContent = formatLocale(rate, { style: 'currency', currency: 'EUR' });
    const kosten = anzahlung + rate * (monate || 0) + restwert;
    gesamtkostenEl.value = formatLocale(kosten, { style: 'currency', currency: 'EUR' });
    const faktor = av > 0 ? (rate / av) * 100 : 0;
    leasingfaktorEl.value = formatLocale(faktor, { style:'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' %';
    updateCostChart(anzahlung, rate * (monate || 0), restwert);
  }

  // Chart
  function updateCostChart(anzahlung, summeRaten, restwert) {
    if (costChart) costChart.destroy();
    const ctx = costChartCanvas.getContext('2d');
    const values = [anzahlung, summeRaten, restwert].map(v => Math.max(0, v));
    const total = values.reduce((a, b) => a + b, 0);
    costChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Anzahlung', 'Summe der Raten', 'Restwert'],
        datasets: [{
          data: values,
          backgroundColor: ['#032659', '#004225', '#E35335'],
          borderColor: '#F8F9FA',
          borderWidth: 5,
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        cutout: '75%',
        plugins: {
          legend: {
            position: 'bottom',
            align: 'start',
            labels: {
              color: '#6C757D',
              padding: 20,
              boxWidth: 12,
              font: { size: 14, family: "'Montserrat', sans-serif" }
            },
            onClick: (e, legendItem, legend) => {
              const idx = legendItem.index;
              const chart = legend.chart;
              chart.toggleDataVisibility(idx);
              chart.update();
              let visibleSum = 0;
              chart.getDatasetMeta(0).data.forEach((arc, i) => {
                if (chart.getDataVisibility(i)) {
                  visibleSum += chart.data.datasets[0].data[i];
                }
              });
              gesamtkostenEl.value = formatLocale(visibleSum, { style: 'currency', currency: 'EUR' });
            }
          },
          tooltip: {
            callbacks: {
              label: ctx => (ctx.label && typeof ctx.parsed === 'number')
                ? `${ctx.label}: ${formatLocale(ctx.parsed, { style: 'currency', currency: 'EUR' })}`
                : ''
            }
          }
        }
      }
    });
    gesamtkostenEl.value = formatLocale(total, { style: 'currency', currency: 'EUR' });
  }

  function showError(msg) { errorText.textContent = msg; }
  function hideError() { errorText.textContent = ''; }

  function setupToggle(toggleEl, inputEl, unitEl) {
    toggleEl.addEventListener('change', () => {
      const av = unformat(document.getElementById('anschaffungswert').value);
      const currentVal = unformat(inputEl.value);
      if (toggleEl.checked) {
        unitEl.textContent = '(%)';
        if (av > 0) {
          inputEl.value = formatLocale((currentVal / av) * 100, { style:'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        } else {
          inputEl.value = formatLocale(currentVal, { style:'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
      } else {
        unitEl.textContent = '(€)';
        if (av > 0) {
          inputEl.value = formatLocale((currentVal / 100) * av, { style:'decimal', maximumFractionDigits: 0 });
        } else {
          inputEl.value = formatLocale(currentVal, { style:'decimal', maximumFractionDigits: 0 });
        }
      }
      formatInput({ target: inputEl });
    });
  }

  // Initial Setup & Events
  setupToggle(anzahlungToggle, document.getElementById('anzahlung'), anzahlungUnit);
  setupToggle(restwertToggle, document.getElementById('restwert'), restwertUnit);
  setupToggle(margeToggle, document.getElementById('margegesamt'), margeUnit);

  document.querySelectorAll('.numeric-input, #laufzeit').forEach(input => {
    input.addEventListener('blur', formatInput);
    formatInput({ target: input });
  });

  const calculateBtn = document.getElementById('calculate-btn'); // re-affirm
  calculateBtn.addEventListener('click', () => {
    calculateBtn.dataset.clicked = "true";
    performCalculation();
  });

  resetButton.addEventListener('click', resetAllInputs);

  // Info Tooltip
  infoButton.addEventListener('mouseenter', () => infoTooltip.classList.remove('hidden'));
  infoButton.addEventListener('mouseleave', () => infoTooltip.classList.add('hidden'));

  // Angebot Toggle
  offerToggleBtn.addEventListener('click', () => {
    const isOpen = offerContainer.classList.toggle('open-offer');
    offerIcon.style.transform = isOpen ? 'rotate(45deg)' : 'rotate(0deg)';
    offerContainer.style.maxHeight = isOpen ? offerContainer.scrollHeight + 'px' : null;
  });

  // PDF
  pdfButton.addEventListener('click', () => {
    const offerErrorMessage = document.getElementById('offer-error-message');
    const requiredFields = Array.from(offerContainer.querySelectorAll('[required]'));
    let isFormValid = true;

    requiredFields.forEach(field => {
      const parent = field.closest('.relative');
      const icon = parent?.querySelector('.error-icon');
      field.classList.remove('has-error');
      if (icon) icon.classList.add('hidden');
    });

    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        isFormValid = false;
        const parent = field.closest('.relative');
        const icon = parent?.querySelector('.error-icon');
        field.classList.add('has-error');
        if (icon) icon.classList.remove('hidden');
      }
    });

    if (!resultText.textContent || resultContainer.classList.contains('hidden')) {
      offerErrorMessage.textContent = 'Bitte führen Sie zuerst eine gültige Berechnung durch.';
      offerErrorMessage.classList.remove('hidden');
      isFormValid = false;
      if (calculateBtn) calculateBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    if (!isFormValid) {
      if (!offerErrorMessage.textContent) {
        offerErrorMessage.textContent = 'Bitte füllen Sie alle markierten Felder aus, um das Angebot herunterzuladen.';
        offerErrorMessage.classList.remove('hidden');
      }
      const firstError = offerContainer.querySelector('.has-error');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstError.focus({ preventScroll: true });
      }
      return;
    }

    offerErrorMessage.classList.add('hidden');

    const values = {
      anschaffungswertRaw: unformat(document.getElementById('anschaffungswert').value),
      laufzeit: document.getElementById('laufzeit').value,
      anzahlungRaw: unformat(document.getElementById('anzahlung').value),
      anzahlungToggle: anzahlungToggle.checked,
      restwertRaw: unformat(document.getElementById('restwert').value),
      restwertToggle: restwertToggle.checked,
      monatlicheRate: resultText.textContent,
      finanzierungsart: document.getElementById('finanzierungsart').value,
      anrede: document.getElementById('anrede').value,
      nachname: document.getElementById('nachname').value,
      firma: document.getElementById('firma').value,
      adresse: document.getElementById('adresse').value,
      plz: document.getElementById('plz').value,
      ort: document.getElementById('ort').value,
      objekt: document.getElementById('objekt').value,
      hersteller: document.getElementById('hersteller').value,
    };

    const avNum = values.anschaffungswertRaw;
    const anzahlungEuro = values.anzahlungToggle ? (values.anzahlungRaw / 100) * avNum : values.anzahlungRaw;
    const restwertEuro = values.restwertToggle ? (values.restwertRaw / 100) * avNum : values.restwertRaw;
    const entgeltEuro = restwertEuro;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(0);
    pdf.setFontSize(10);

    let y = 25;
    const leftMargin = 20;
    const valueXPos = 70;
    const pageWidth = pdf.internal.pageSize.getWidth();
    const contentWidth = pageWidth - leftMargin * 2;
    const lineSpacing = 6;
    const sectionSpacing = 10;

    const addressStartY = y;
    if (values.firma) { pdf.text(values.firma, leftMargin, y); y += 5; }
    if (values.anrede || values.nachname) { pdf.text(`${values.anrede || ''} ${values.nachname || ''}`.trim(), leftMargin, y); y += 5; }
    if (values.adresse) { pdf.text(values.adresse, leftMargin, y); y += 5; }
    if (values.plz || values.ort) { pdf.text(`${values.plz || ''} ${values.ort || ''}`.trim(), leftMargin, y); y += 5; }
    y = Math.max(y, addressStartY) + sectionSpacing * 1.5;

    pdf.setFontSize(11);
    pdf.setFont('helvetica', 'bold');
    if(values.objekt || values.hersteller) {
      pdf.text(`Finanzierungsangebot: ${values.objekt || ''} ${values.hersteller || ''}`.trim(), leftMargin, y);
    } else {
      pdf.text(`Finanzierungsangebot`, leftMargin, y);
    }
    y += lineSpacing * 2;

    pdf.setFont('helvetica', 'normal');
    pdf.setFontSize(11);
    pdf.text(`Sehr ${values.anrede === 'Frau' ? 'geehrte Frau' : 'geehrter Herr'} ${values.nachname || ''},`, leftMargin, y);
    y += lineSpacing * 1.5;

    const requestType = values.finanzierungsart === 'Mietkauf' ? 'Mietkaufanfrage' : 'Leasinganfrage';
    pdf.text(`wir danken für Ihre ${requestType} und bieten wie folgt unverbindlich an:`, leftMargin, y);
    y += sectionSpacing * 1.5;

    const addDetailLinePDF = (label, value) => {
      if (value || value === 0 || String(value).replace(/[€\s]/g, '').trim() !== '') {
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'bold');
        pdf.text(`${label}:`, leftMargin, y);
        pdf.setFont('helvetica', 'normal');
        pdf.text(String(value), valueXPos, y);
        y += lineSpacing;
      }
    };

    addDetailLinePDF('Anschaffungspreis', formatLocale(avNum, { style: 'currency', currency: 'EUR'}));
    addDetailLinePDF('Laufzeit', values.laufzeit ? `${values.laufzeit} Monate` : 'N/A');
    addDetailLinePDF('Mietsonderzahlung', formatLocale(anzahlungEuro, { style: 'currency', currency: 'EUR'}));
    addDetailLinePDF('Monatliche Rate', values.monatlicheRate);
    addDetailLinePDF('Restwert', formatLocale(restwertEuro, { style: 'currency', currency: 'EUR'}));

    y += lineSpacing * 0.5;

    const addWrappedTextPDF = (text, startY, margin, width, lineSpacingScale = 1.0, isBold = false) => {
      const currentSize = pdf.getFontSize();
      const currentStyle = pdf.getFont().fontStyle;
      if (isBold) pdf.setFont('helvetica', 'bold'); else pdf.setFont('helvetica', 'normal');
      const lines = pdf.splitTextToSize(text, width);
      pdf.text(lines, margin, startY);
      pdf.setFont('helvetica', currentStyle);
      pdf.setFontSize(currentSize);
      return startY + (lines.length * (lineSpacing * 0.8) * lineSpacingScale);
    };

    if (values.finanzierungsart === 'Mietkauf') {
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(0);
      y = addWrappedTextPDF('Hinweis: Die gesetzl. Mehrwertsteuer fällt vorab auf die Summe aller Zahlungen an.', y, leftMargin, contentWidth, 1.0, true);
      pdf.setFont('helvetica', 'normal');
      y += lineSpacing * 0.5;
    }

    pdf.setFontSize(9);
    pdf.setTextColor(0);
    y = addWrappedTextPDF('Die oben genannten Preise verstehen sich netto, zuzüglich der gesetzlichen Mehrwertsteuer.', y, leftMargin, contentWidth);
    const formattedEntgelt = formatLocale(entgeltEuro, { style: 'currency', currency: 'EUR' });
    y = addWrappedTextPDF(`Bei Vertragsabschluss berechnet die Leasinggesellschaft Ihnen einmalig ein Entgelt in Höhe von ${formattedEntgelt}.`, y, leftMargin, contentWidth);
    y += sectionSpacing;

    pdf.setFontSize(10);
    y = addWrappedTextPDF('Gerne begleiten wir Sie auch bei weiteren Investitionen in Ihren Betrieb. Kommen Sie ganz unverbindlich auf uns zu.', y, leftMargin, contentWidth, 1.2);
    y = addWrappedTextPDF('Wir freuen uns, für Sie tätig werden zu können und sichern Ihnen bereits jetzt eine faire, schnelle und unbürokratische Abwicklung zu.', y, leftMargin, contentWidth, 1.2);
    y += sectionSpacing * 1.5;

    pdf.text('Mit freundlichen Grüßen', leftMargin, y);

    const pdfTitle = `${values.finanzierungsart || 'Finanzierung'}svertrag (${values.nachname || 'Kunde'}).pdf`;
    pdf.save(pdfTitle);
  });

  // Select placeholder
  document.querySelectorAll('select.is-placeholder').forEach(select => {
    select.addEventListener('change', (e) => {
      if (e.target.value) { e.target.classList.remove('is-placeholder'); }
      else { e.target.classList.add('is-placeholder'); }
    });
    if (select.value) { select.classList.remove('is-placeholder'); }
  });

  // History Modal
  const openHistoryModal = () => {
    loadHistory();
    historySearchInput.value = '';
    historyModal.classList.remove('opacity-0', 'pointer-events-none');
    historyPanel.classList.remove('-translate-y-10');
    historySearchInput.focus();
  };
  const closeHistoryModal = () => {
    historyModal.classList.add('opacity-0', 'pointer-events-none');
    historyPanel.classList.add('-translate-y-10');
  };
  historyButton.addEventListener('click', openHistoryModal);
  closeHistoryButton.addEventListener('click', closeHistoryModal);
  historyModal.addEventListener('click', (e) => {
    if (e.target === historyModal) { closeHistoryModal(); }
  });
  historySearchInput.addEventListener('input', (e) => { loadHistory(e.target.value); });

  const saveCalculationToHistory = (rate, offerData) => {
    if (isNaN(rate) || !isFinite(rate)) return;

    const historyEntry = {
      timestamp: new Date().toISOString(),
      anschaffungswert: document.getElementById('anschaffungswert').value,
      laufzeit: document.getElementById('laufzeit').value,
      anzahlung: document.getElementById('anzahlung').value,
      anzahlungToggle: document.getElementById('anzahlung-toggle').checked,
      restwert: document.getElementById('restwert').value,
      restwertToggle: document.getElementById('restwert-toggle').checked,
      basiszins: document.getElementById('basiszins').value,
      margegesamt: document.getElementById('margegesamt').value,
      margeToggle: document.getElementById('marge-toggle').checked,
      monatlicheRate: formatLocale(rate, { style: 'currency', currency: 'EUR' }),
      finanzierungsart: offerData.finanzierungsart || '',
      anrede: offerData.anrede || '',
      vorname: offerData.vorname || '',
      nachname: offerData.nachname || '',
      firma: offerData.firma || '',
      adresse: offerData.adresse || '',
      plz: offerData.plz || '',
      ort: offerData.ort || '',
      objekt: offerData.objekt || '',
      hersteller: offerData.hersteller || '',
    };

    let history = JSON.parse(localStorage.getItem('financingHistory')) || [];
    if (history.length > 0) {
      const lastEntry = history[0];
      const calcKeysToCompare = ['anschaffungswert', 'laufzeit', 'anzahlung', 'restwert', 'basiszins', 'margegesamt'];
      const offerKeysToCompare = ['finanzierungsart', 'anrede', 'vorname', 'nachname', 'firma', 'adresse', 'plz', 'ort', 'objekt', 'hersteller'];
      const calcIsDuplicate =
        calcKeysToCompare.every(key => historyEntry[key] === lastEntry[key]) &&
        historyEntry.anzahlungToggle === lastEntry.anzahlungToggle &&
        historyEntry.restwertToggle === lastEntry.restwertToggle &&
        historyEntry.margeToggle === lastEntry.margeToggle;
      const offerIsDuplicate = offerKeysToCompare.every(key => historyEntry[key] === lastEntry[key]);
      if (calcIsDuplicate && offerIsDuplicate) { return; }
    }

    history.unshift(historyEntry);
    if (history.length > 50) { history = history.slice(0, 50); }
    localStorage.setItem('financingHistory', JSON.stringify(history));
  };

  const loadHistory = (searchTerm = '') => {
    historyList.innerHTML = '';
    let history = JSON.parse(localStorage.getItem('financingHistory')) || [];
    const lowerSearchTerm = searchTerm.toLowerCase().trim();

    if (lowerSearchTerm) {
      history = history.filter(entry => {
        const checkEntry = (obj) => {
          for (const key in obj) {
            if (Object.prototype.hasOwnProperty.call(obj, key)) {
              const value = obj[key];
              if (typeof value === 'string' && value.toLowerCase().includes(lowerSearchTerm)) return true;
              else if (typeof value === 'number' && String(value).toLowerCase().includes(lowerSearchTerm)) return true;
              if (key === 'anschaffungswert' && entry.anschaffungswert?.replace(/[.,€\s]/g, '').includes(lowerSearchTerm)) return true;
              if (key === 'monatlicheRate' && entry.monatlicheRate?.replace(/[.,€\s]/g, '').includes(lowerSearchTerm)) return true;
              if (key === 'anzahlung' && entry.anzahlung?.replace(/[.,€%\s]/g, '').includes(lowerSearchTerm)) return true;
              if (key === 'restwert' && entry.restwert?.replace(/[.,€%\s]/g, '').includes(lowerSearchTerm)) return true;
              if (key === 'basiszins' && entry.basiszins?.replace(/[%.,\s]/g, '').includes(lowerSearchTerm)) return true;
              if (key === 'margegesamt' && entry.margegesamt?.replace(/[.,€%\s]/g, '').includes(lowerSearchTerm)) return true;
            }
          }
          return false;
        };
        return checkEntry(entry);
      });
    }

    if (history.length === 0) {
      historyList.innerHTML = lowerSearchTerm
        ? `<p class="text-slate-500 text-center py-8">Keine Einträge für "${searchTerm}" gefunden.</p>`
        : `<p class="text-slate-500 text-center py-8">Noch keine Berechnungen gespeichert.</p>`;
      return;
    }

    history.forEach((entry) => {
      const date = new Date(entry.timestamp);
      const formattedDate = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
      const formattedTime = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

      let displayName = 'N/A';
      if (entry.nachname) displayName = entry.nachname;
      else if (entry.firma) displayName = entry.firma;
      else if (entry.vorname) displayName = entry.vorname;
      else if (entry.objekt) displayName = entry.objekt;

      const item = document.createElement('div');
      item.className = 'p-4 border border-gray-200 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors group';
      item.innerHTML = `
        <div class="flex justify-between items-start gap-4">
          <div class="flex-grow min-w-0">
            <p class="font-semibold text-lg text-[#032659] mb-1 truncate">${entry.monatlicheRate || 'N/A'}
              <span class="text-sm font-normal text-slate-500 ml-2">(${displayName})</span>
            </p>
            <p class="text-sm text-slate-600 truncate">
              <span title="Anschaffungswert">AW: ${formatLocale(unformat(entry.anschaffungswert), { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 })}</span> |
              <span title="Laufzeit">LZ: ${entry.laufzeit} M</span> |
              <span title="Anzahlung">A${entry.anzahlungToggle ? '%' : '€'}: ${entry.anzahlung}</span> |
              <span title="Restwert">R${entry.restwertToggle ? '%' : '€'}: ${entry.restwert}</span> |
              <span title="Basiszinssatz">BZ: ${entry.basiszins}%</span> |
              <span title="Marge">M${entry.margeToggle ? '%' : '€'}: ${entry.margegesamt}</span>
            </p>
          </div>
          <div class="text-right flex-shrink-0">
            <p class="text-xs text-slate-400">${formattedDate}</p>
            <p class="text-xs text-slate-400">${formattedTime} Uhr</p>
          </div>
          <button class="delete-history-item p-1.5 rounded-full hover:bg-red-100 transition-colors self-center flex-shrink-0" data-timestamp="${entry.timestamp}" title="Diesen Eintrag löschen">
            <svg class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      `;
      item.querySelector('.delete-history-item').addEventListener('click', (e) => {
        e.stopPropagation();
        deleteHistoryEntry(e.currentTarget.dataset.timestamp);
      });
      item.addEventListener('click', () => { restoreFromHistory(entry); });
      historyList.appendChild(item);
    });
  };

  const deleteHistoryEntry = (timestampToDelete) => {
    let history = JSON.parse(localStorage.getItem('financingHistory')) || [];
    const updatedHistory = history.filter(entry => entry.timestamp !== timestampToDelete);
    localStorage.setItem('financingHistory', JSON.stringify(updatedHistory));
    loadHistory(historySearchInput.value);
  };

  const restoreFromHistory = (entry) => {
    document.getElementById('anschaffungswert').value = entry.anschaffungswert;
    document.getElementById('laufzeit').value = entry.laufzeit;
    document.getElementById('basiszins').value = entry.basiszins;
    document.getElementById('anzahlung').value = entry.anzahlung;
    document.getElementById('restwert').value = entry.restwert;
    document.getElementById('margegesamt').value = entry.margegesamt;

    document.getElementById('anzahlung-toggle').checked = entry.anzahlungToggle;
    document.getElementById('restwert-toggle').checked = entry.restwertToggle;
    document.getElementById('marge-toggle').checked = entry.margeToggle;

    document.getElementById('anzahlung-unit').textContent = entry.anzahlungToggle ? '(%)' : '(€)';
    document.getElementById('restwert-unit').textContent = entry.restwertToggle ? '(%)' : '(€)';
    document.getElementById('marge-unit').textContent = entry.margeToggle ? '(%)' : '(€)';

    document.getElementById('finanzierungsart').value = entry.finanzierungsart || '';
    document.getElementById('anrede').value = entry.anrede || '';
    document.getElementById('vorname').value = entry.vorname || '';
    document.getElementById('nachname').value = entry.nachname || '';
    document.getElementById('firma').value = entry.firma || '';
    document.getElementById('adresse').value = entry.adresse || '';
    document.getElementById('plz').value = entry.plz || '';
    document.getElementById('ort').value = entry.ort || '';
    document.getElementById('objekt').value = entry.objekt || '';
    document.getElementById('hersteller').value = entry.hersteller || '';

    document.querySelectorAll('select.is-placeholder').forEach(select => {
      if (select.value) { select.classList.remove('is-placeholder'); }
      else { select.classList.add('is-placeholder'); }
    });

    document.querySelectorAll('.numeric-input, #laufzeit').forEach(input => formatInput({ target: input }));

    calculateBtn.dataset.clicked = "true";
    performCalculation(true);
    closeHistoryModal();
  };

  // Initial on load
  document.addEventListener('DOMContentLoaded', () => {
    showPlaceholder();
    document.querySelectorAll('.numeric-input').forEach(input => {
      input.addEventListener('blur', formatInput);
      formatInput({ target: input });
    });
    const laufzeitInput = document.getElementById('laufzeit');
    laufzeitInput.addEventListener('blur', formatInput);
    formatInput({ target: laufzeitInput });
    document.querySelectorAll('select.is-placeholder').forEach(select => {
      if (!select.value) select.classList.add('is-placeholder');
    });
  });

</script>
</body>
</html>
